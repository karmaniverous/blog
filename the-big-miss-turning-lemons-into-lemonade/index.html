<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>The Big Miss: Turning Lemons Into Lemonade - some words</title>
<meta name="description" content="Today was one of those days when I question my life choices. Watch me dig my way out of a hole with the same shovel I used to dig my way in.">


  <meta name="author" content="Jason Williscroft">
  
  <meta property="article:author" content="Jason Williscroft">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="some words">
<meta property="og:title" content="The Big Miss: Turning Lemons Into Lemonade">
<meta property="og:url" content="https://karmanivero.us/the-big-miss-turning-lemons-into-lemonade/">


  <meta property="og:description" content="Today was one of those days when I question my life choices. Watch me dig my way out of a hole with the same shovel I used to dig my way in.">



  <meta property="og:image" content="https://karmanivero.us/assets/images/lemons-banner.jpg">



  <meta name="twitter:site" content="@karmaniverous">
  <meta name="twitter:title" content="The Big Miss: Turning Lemons Into Lemonade">
  <meta name="twitter:description" content="Today was one of those days when I question my life choices. Watch me dig my way out of a hole with the same shovel I used to dig my way in.">
  <meta name="twitter:url" content="https://karmanivero.us/the-big-miss-turning-lemons-into-lemonade/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://karmanivero.us/assets/images/lemons-banner.jpg">
  

  



  <meta property="article:published_time" content="2024-11-20T00:00:00+00:00">






<link rel="canonical" href="https://karmanivero.us/the-big-miss-turning-lemons-into-lemonade/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="some words Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  window.enable_copy_code_button = true;
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/assets/favicon/apple-touch-icon.png" />
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/assets/favicon/favicon-32x32.png" />
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/assets/favicon/favicon-16x16.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />
<link
  rel="mask-icon"
  href="/assets/favicon/safari-pinned-tab.svg"
  color="#5bbad5" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<meta name="msapplication-TileColor" content="#2b5797" />
<meta name="msapplication-config" content="/assets/favicon/browserconfig.xml" />
<meta name="theme-color" content="#ffffff" />



<!-- Mathjax Support -->
<script
  type="text/javascript"
  async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          some words
          <span class="site-subtitle">many of them true</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/projects/"
                
                
              >Projects</a>
            </li><li class="masthead__menu-item">
              <a
                href="/toolkits/"
                
                
              >Toolkits</a>
            </li><li class="masthead__menu-item">
              <a
                href="/bali/"
                
                
              >Bali</a>
            </li><li class="masthead__menu-item">
              <a
                href="/topics/"
                
                
              >Topics</a>
            </li><li class="masthead__menu-item">
              <a
                href="/blog/"
                
                
              >Archive</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://karmanivero.us/">
        <img src="/assets/images/bio-photo.jpg" alt="Jason Williscroft" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://karmanivero.us/" itemprop="url">Jason Williscroft</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p><em>resume bullets<br />may read differently at the<br />threshold of heaven</em></p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Contact</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://twitter.com/karmaniverous" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-brands fa-square-x-twitter" aria-hidden="true"></i><span class="label">X</span></a></li>
          
        
          
            <li><a href="https://techhub.social/@karmaniverous" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-brands fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://github.com/karmaniverous" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-brands fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/jscroft/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-brands fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://wa.me/17737500338" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-brands fa-whatsapp" aria-hidden="true"></i><span class="label">WhatsApp</span></a></li>
          
        
          
            <li><a href="https://t.me/karmaniverous" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-brands fa-telegram" aria-hidden="true"></i><span class="label">Telegram</span></a></li>
          
        
          
            <li><a href="https://calendly.com/karmaniverous" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fa-regular fa-calendar-plus" aria-hidden="true"></i><span class="label">Meet</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article
    class="page"
    itemscope
    itemtype="https://schema.org/CreativeWork"
    >
    <meta itemprop="headline" content="The Big Miss: Turning Lemons Into Lemonade">
    <meta itemprop="description" content="Today was one of those days when I question my life choices. Watch me dig my way out of a hole with the same shovel I used to dig my way in.">
    <meta itemprop="datePublished" content="2024-11-20T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1
              id="page-title"
              class="page__title"
              itemprop="headline">
              <a href="https://karmanivero.us/the-big-miss-turning-lemons-into-lemonade/" itemprop="url">The Big Miss: Turning Lemons Into Lemonade
</a>
            </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i
          class="far fa-calendar-alt"
          aria-hidden="true"
        ></i>
        
        <time datetime="2024-11-20T00:00:00+00:00">November 20, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-clock"
          aria-hidden="true"
        ></i>
        
          8
          minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header>
                <h4 class="nav__title">
                  <i class="fas fa-file-alt"></i>
                  On this page</h4>
              </header>
              <ul class="toc__menu"><li><a href="#the-entity-manager-refactor">The Entity Manager Refactor</a></li><li><a href="#a-hidden-bombshell">A Hidden Bombshell</a></li><li><a href="#the-big-miss">The Big Miss</a></li><li><a href="#turning-lemons-into-lemonade">Turning Lemons Into Lemonade</a></li><li><a href="#conclusion">Conclusion</a></li></ul>
            </nav>
          </aside>
        
        <figure class="align-left drop-image">
    <img src="/assets/images/lemons-square.jpg" />
</figure>

<p>Today was one of those days when I question my life choices. I could have stayed in the freaking Navy.</p>

<p>Tell me if you’ve seen this movie before: You have a tool that works well in production. You embark on a major refactor, and you do it professionally: architecture, design, documentation, and everything tested to the nines. You write a demo that doubles as an integration test, and <strong><em>it blows up like a hair-metal third-encore finale!</em></strong></p>

<p>Moreover, <strong>it invalidates one of your basic architectural premises</strong>, and you realize with a sick jerk that the earlier version—you know, the one that <em>works well in production</em>—has been a shaky house of cards all along.</p>

<p>Ugh.</p>

<h2 id="the-entity-manager-refactor">The Entity Manager Refactor</h2>

<p><a href="/projects/entity-manager/intro/">Entity Manager</a> is a library that takes the ouch out of applying the <a href="https://aws.amazon.com/blogs/compute/creating-a-single-table-design-with-amazon-dynamodb/">single-table design pattern</a> to a <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a> database. I’ve been running Entity Manager across 16 back-end services at <a href="https://veterancrowd.com">VeteranCrowd</a> (ignore the ugly home page, please) for over a year, and it’s <em>awesome</em>.</p>

<p>The production version of Entity Manager is written in Javascript. A few months ago I embarked on a complete rewrite of the library that encapsulates a long list of lessons learned. See <a href="/topics/entity-manager/">this archive</a> for some dispatches from that journey.</p>

<p>The new version is cleaner, faster, and <em>way</em> easier to configure &amp; use. It’s also Typescript from the ground up, and is about as obsessively unit tested as I can make it.</p>

<p>This morning I discovered that the Entity Manager refactor is a <em>solid</em>, relentlessly <em>perfect</em> implementation of <strong>the wrong effing thing!</strong></p>

<h2 id="a-hidden-bombshell">A Hidden Bombshell</h2>

<p>A key Entity Manager feature is behind-the-scenes declarative <a href="https://aws.amazon.com/what-is/database-sharding">partition sharding</a>. There are arguments for and against doing this in <a href="https://aws.amazon.com/pm/dynamodb">DynamoDB</a>, but Entity Manager is a platform-agnostic tool, so sharding is a feature that’s been in there since the beginning.</p>

<p>See <a href="/projects/entity-manager/evolving-a-nosql-db-schema/#shard-keys">this article section</a> for a deep dive into Entity Manager’s sharding strategy, but here’s the TL/DR:</p>

<ul>
  <li>
    <p>A NoSQL database record is accessed by its <em>primary key</em>.</p>
  </li>
  <li>
    <p>The primary component has two components: the <em>hash key</em> and the <em>sort key</em>. And you can only have so much stuff with the same hash key in a single table.</p>
  </li>
  <li>
    <p>Entity Manager supports multiple entities on a single table. So it composes the hash key from the entity type and a deterministically calculated <em>shard key</em>. A typical Entity Manager hash key looks like <code class="language-plaintext highlighter-rouge">user!1f</code> or <code class="language-plaintext highlighter-rouge">email!2a</code>.</p>
  </li>
  <li>
    <p>Entity manager supports an evolving sharding scheule, so your data can scale over time. So the inputs to the shard key are the the record’s unique identifier and the record creation date.</p>
  </li>
</ul>

<p>In the default case sharding is turned off, and the shard key is an empty string.</p>

<p>Can you see where this is going? 👀 <em>Because I didn’t!</em></p>

<p>The core Entity Manager package (<a href="https://github.com/karmaniverous/entity-manager"><code class="language-plaintext highlighter-rouge">entity-manager</code></a>) is all about manipulating data records to add appropriate generated properties, remove them, and support searching across shards and indexes. It is exhaustively unit-tested, but at no point does it retrieve a record from a database. At its high level of abstraction, the package doesn’t even know what a database <em>is</em>.</p>

<p>One thing it <em>can</em> do: generate a primary key from a sufficiently-populated entity record.</p>

<p>The DynamoDB-specific Entity Manager client package (<a href="https://github.com/karmaniverous/entity-client-dynamodb"><code class="language-plaintext highlighter-rouge">entity-client-dynamodb</code></a>) is all about tying the core package to the DynamoDB SDK. Given enough data—for example, the components of a primary key—it conducts CRUD operations and executes multi-index, cross-shard searches against DynamoDB. And it also works flawlessly.</p>

<p>But in the demo package (<a href="https://github.com/karmaniverous/entity-manager-demo"><code class="language-plaintext highlighter-rouge">entity-manager-demo</code></a>), we actually get to execute a real-world scenario:</p>

<ul>
  <li>
    <p>Create a record in a database (which returns a new unique id).</p>
  </li>
  <li>
    <p>Turn around &amp; retrieve the record by its unique id.</p>
  </li>
  <li>
    <p>Update the record, etc…</p>
  </li>
</ul>

<p>And that’s where the bomb went off.</p>

<h2 id="the-big-miss">The Big Miss</h2>

<p>Before I can retrieve a record by its unique id, I need to generate the record’s primary key.</p>

<p>Internally, Entity Manager’s primary key generator calculates the record’s shard key… which depends on the record’s creation date. <strong>Which I don’t have yet.</strong></p>

<p>So the primary key generator throws an exception and the <code class="language-plaintext highlighter-rouge">GET</code> fails.</p>

<p>Remember, the previous version has been running flawlessly in sixteen production services for over a year! Only the system hasn’t scaled yet, so <strong>I have sharding turned off in every service.</strong> And, since JavaScript isn’t type-safe and I wasn’t validating the presence of a timestamp at runtime, the code never complained that it was getting an <code class="language-plaintext highlighter-rouge">undefined</code> instead of a <code class="language-plaintext highlighter-rouge">number</code>.</p>

<p>In production, Entity Manager has been returning the right answer every time… <strong><em>but only by accident!</em></strong></p>

<p>Even now, this showed up as a runtime error instead of a type error because (I just checked) the <code class="language-plaintext highlighter-rouge">getPrimaryKey</code> function is <a href="https://github.com/karmaniverous/entity-manager/blob/main/src/EntityManager/getPrimaryKey.ts#L25">expecting the wrong type</a>, incorrect because it is too permissive. But since the refactor is <em>way</em> more obsessive about validating runtime inputs, it caught the missing timestamp <a href="https://github.com/karmaniverous/entity-manager/blob/main/src/EntityManager/updateItemHashKey.ts#L56">here</a> and threw an exception.</p>

<p>In cross-shard searching at scale, the relationship between shard key and record creation date provides a <em>huge</em> advantage, since any search constrained by creation date can naturally constrain the space of shard keys it has to search. Big win.</p>

<p>But the most important operation anybody performs against a database is the retrieval of a single record. And in this case, Entity Manager’s current sharding strategy is <em>fundamentally flawed</em> because it won’t let you retrieve a record by its unique id alone.</p>

<p>Damn.</p>

<h2 id="turning-lemons-into-lemonade">Turning Lemons Into Lemonade</h2>

<p>In the current Entity Manager config object, a given entity’s sharding strategy looks like this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">entityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EntityManager</span><span class="o">&lt;</span><span class="nx">MyConfigMap</span><span class="o">&gt;</span><span class="p">({</span>
  <span class="na">entities</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">email</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">shardBumps</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">charBits</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">chars</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span> <span class="na">charBits</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">chars</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">],</span>
      <span class="na">timestampProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">created</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">uniqueProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">shardBumps</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">charBits</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">chars</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span> <span class="na">charBits</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">chars</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">],</span>
      <span class="na">timestampProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">created</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">uniqueProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This means…</p>

<ul>
  <li>
    <p>For <code class="language-plaintext highlighter-rouge">email</code> records created before timestamp <code class="language-plaintext highlighter-rouge">1234567890</code>, all records have an empty shard key, so their hash keys are all <code class="language-plaintext highlighter-rouge">email!</code>.</p>
  </li>
  <li>
    <p>For <code class="language-plaintext highlighter-rouge">email</code> records created at and after timestamp <code class="language-plaintext highlighter-rouge">1234567890</code>, records will be distributed across a one-character, two-bit shard key. So each of these records will have one of these four hash keys: <code class="language-plaintext highlighter-rouge">email!0</code>, <code class="language-plaintext highlighter-rouge">email!1</code>, <code class="language-plaintext highlighter-rouge">email!2</code>, or <code class="language-plaintext highlighter-rouge">email!3</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">user</code> records have the same schedule, but their scheduled bump is to a one-bit character instead of a two-bit character. So each of these records will have one of these two hash keys: <code class="language-plaintext highlighter-rouge">user!0</code> or <code class="language-plaintext highlighter-rouge">user!1</code>.</p>
  </li>
</ul>

<p class="notice--info"><strong>Obviously this is a toy scenario.</strong> In the real-world, you’d probably want a deeper shard key. But the principle is the same.</p>

<p>The calling application is responsible for providing the value of the unique property (in this case <code class="language-plaintext highlighter-rouge">email</code> or <code class="language-plaintext highlighter-rouge">userId</code>) that is the other basis (besides creation timestamp) of the shard key hash. And as we discussed above, this timestamp dependency is critical for supporting efficient cross-shard searches.</p>

<p>In some cases there may be no unique id intrinsic to the data. A user record is a good example of this: in our demo app we generate a <a href="https://github.com/ai/nanoid"><code class="language-plaintext highlighter-rouge">nanoid</code></a> for every new user. In other cases, the unique id is a natural part of the data, like an email address. Either way, the resulting value is encoded directly into the record’s range key, like this: <code class="language-plaintext highlighter-rouge">userId#abc123</code>.</p>

<p>But what if we made a slight enhancement to the shard key generation strategy?</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">entityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EntityManager</span><span class="o">&lt;</span><span class="nx">MyConfigMap</span><span class="o">&gt;</span><span class="p">({</span>
  <span class="na">entities</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">email</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">shardBumps</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">charBits</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">chars</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">rangeKeyLength</span><span class="p">:</span> <span class="mi">21</span> <span class="p">},</span>
        <span class="p">{</span>
          <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
          <span class="na">charBits</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="na">chars</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="na">rangeKeyLength</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">],</span>
      <span class="na">timestampProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">created</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">uniqueProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">emailId</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">shardBumps</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">charBits</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">chars</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">rangeKeyLength</span><span class="p">:</span> <span class="mi">21</span> <span class="p">},</span>
        <span class="p">{</span>
          <span class="na">timestamp</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
          <span class="na">charBits</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="na">chars</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="na">rangeKeyLength</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">],</span>
      <span class="na">timestampProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">created</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">uniqueProperty</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Either way, a record’s range key is determined at the point of creation.</p>

<p>But now, instead of encoding the range key as described above, we can generate a random string of a specific length. This length is determined by looking up the record’s creation timestamp in the config and getting <code class="language-plaintext highlighter-rouge">rangeKeyLength</code>.</p>

<p>Previously, the shard key generator determined the bit depth &amp; length of the shard key by looking up some <em>timestamp</em> in the config. This is still possible, for example when generating a shard key space to support cross shard searches.</p>

<p>But now, the shard key generator can <em>also</em> determine the bit depth and length of its shard key by looking up <em>the length of the record’s range key</em> in the config!</p>

<p>In the User case, this means that <code class="language-plaintext highlighter-rouge">userId</code> no longer needs to be generated by the application. It’s generated automatically when keys are added to the data record.</p>

<p>In the Email case, note that we have a new <code class="language-plaintext highlighter-rouge">uniqueProperty</code>: <code class="language-plaintext highlighter-rouge">emailId</code>. <code class="language-plaintext highlighter-rouge">email</code> is still an Email record property, but it no longer participates in key generation.</p>

<p>In fact, any “unique” property specific to the application (like <code class="language-plaintext highlighter-rouge">email</code>) can now be treated just like any non-unique property (like <code class="language-plaintext highlighter-rouge">lastName</code>). If you need to find a record with it, create an index and query it. Entity Manager’s cross-shard queries work just as well either way.</p>

<h2 id="conclusion">Conclusion</h2>

<p>These changes are going to take a little doing to implement, but this mess isn’t half the disaster it looked to be when that first integration test failed this morning.</p>

<p>Quite the opposite:</p>

<ul>
  <li>
    <p>We’ve taken unique key generation completely out of the hands of the calling application. One less dependency for sure, and also eliminated the possibility of key collisions due to some weirdness on the epplication end of things.</p>
  </li>
  <li>
    <p>We’ve defused a ticking time bomb that runs across the entire back end of an application I am directly responsible for. That’s a career-bending problem I didn’t even know I had until this morning, and it’s a relief to know it will be accounted for in Entity Manager’s next production release.</p>
  </li>
</ul>

<p>I’m not happy about the bug, but I’m <em>thrilled</em> about the fix! So put it all together, and by any standard this is a win.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Topics: </strong>
    <span itemprop="keywords">
    
      <a href="/topics/design" class="page__taxonomy-item p-category" rel="tag">design</a><span class="sep">, </span>
    
      <a href="/topics/dynamodb" class="page__taxonomy-item p-category" rel="tag">dynamodb</a><span class="sep">, </span>
    
      <a href="/topics/entity-manager" class="page__taxonomy-item p-category" rel="tag">entity-manager</a><span class="sep">, </span>
    
      <a href="/topics/javascript" class="page__taxonomy-item p-category" rel="tag">javascript</a><span class="sep">, </span>
    
      <a href="/topics/projects" class="page__taxonomy-item p-category" rel="tag">projects</a><span class="sep">, </span>
    
      <a href="/topics/troubleshooting" class="page__taxonomy-item p-category" rel="tag">troubleshooting</a><span class="sep">, </span>
    
      <a href="/topics/typescript" class="page__taxonomy-item p-category" rel="tag">typescript</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2024-11-20T00:00:00+00:00">November 20, 2024</time></p>

      </footer>

      
        <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=karmaniverous&text=The+Big+Miss%3A+Turning+Lemons+Into+Lemonade%20https%3A%2F%2Fkarmanivero.us%2Fthe-big-miss-turning-lemons-into-lemonade%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fkarmanivero.us%2Fthe-big-miss-turning-lemons-into-lemonade%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://karmanivero.us/the-big-miss-turning-lemons-into-lemonade/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/using-two-whatsapp-accounts-on-the-same-desktop/" class="pagination--pager" title="Using Two WhatsApp Accounts on the Same Desktop
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    




















  



  
  

  
  

  
  

  
  <div class='page__related'>
    
    <h2 class='page__related-title'>
      You may also enjoy
    </h2>
    <div class='grid__wrapper'>

      
      
        
        
        
        
        
        
      

        
      

        
        <!-- post_url: /projects/entity-manager/intro/ -->
        <!-- normLogCommonTags: 0.8888888888888888 -->
        <!-- logAge: 5.0 -->
        <!-- relevance: 47667 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/collections/entity-manager/entity-manager-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/entity-manager/intro/" rel="permalink">Meet Entity Manager!
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-clock"
          aria-hidden="true"
        ></i>
        
          2
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">NoSQL shifts the burden of complexity from the database platform to the developer. Entity Manager sweeps it under the rug!
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /projects/entity-manager/demo/ -->
        <!-- normLogCommonTags: 0.8888888888888888 -->
        <!-- logAge: 5.0 -->
        <!-- relevance: 47667 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/collections/entity-manager/configuration-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/entity-manager/demo/" rel="permalink">Entity Manager: A Demonstration
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-clock"
          aria-hidden="true"
        ></i>
        
          16
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Presenting a step-by-step Typescript implementation of a realistic data model against DynamoDB, with the help of Entity Manager.
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /projects/entity-manager/configuration/ -->
        <!-- normLogCommonTags: 0.8888888888888888 -->
        <!-- logAge: 5.0 -->
        <!-- relevance: 47667 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/collections/entity-manager/configuration-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/entity-manager/configuration/" rel="permalink">Entity Manager Configuration
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-clock"
          aria-hidden="true"
        ></i>
        
          22
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Entity Manager enables efficient put, get, and query operations across entity relationships, indexes, and sharded partitions in a NoSQL database.
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /composition-in-action-finishing-the-swing/ -->
        <!-- normLogCommonTags: 0.8888888888888888 -->
        <!-- logAge: 5.127828052662037 -->
        <!-- relevance: 47539 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="https://github.com/karmaniverous/controlled-proxy/raw/main/assets/controlled-proxy-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/composition-in-action-finishing-the-swing/" rel="permalink">Composition in Action: Finishing the Swing
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i
          class="far fa-fw fa-calendar-alt"
          aria-hidden="true"
        ></i>
        
        <time datetime="2024-10-16T00:00:00+00:00">October 16, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-fw fa-clock"
          aria-hidden="true"
        ></i>
        
          9
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In software engineering, what look to be the easy parts often turn out to be the hard parts. If you’re lucky, the reverse is also true, but don’t count on it.
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /mixin-it-up-picking-the-right-problem-to-solve/ -->
        <!-- normLogCommonTags: 0.8888888888888888 -->
        <!-- logAge: 5.252828052662037 -->
        <!-- relevance: 47414 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/mixin-it-up-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/mixin-it-up-picking-the-right-problem-to-solve/" rel="permalink">Mixin It Up: Picking The Right Problem to Solve
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i
          class="far fa-fw fa-calendar-alt"
          aria-hidden="true"
        ></i>
        
        <time datetime="2024-10-12T00:00:00+00:00">October 12, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-fw fa-clock"
          aria-hidden="true"
        ></i>
        
          9
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Sometimes, when you’re tangled up in a thorny problem, solving it is exactly the wrong answer.
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /loggable-a-typescript-mixin-for-generic-class-logging/ -->
        <!-- normLogCommonTags: 0.8888888888888888 -->
        <!-- logAge: 5.284078052662037 -->
        <!-- relevance: 47383 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="https://raw.githubusercontent.com/karmaniverous/loggable/main/assets/loggable-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/loggable-a-typescript-mixin-for-generic-class-logging/" rel="permalink">Loggable: A TypeScript Mixin for Generic Class Logging
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i
          class="far fa-fw fa-calendar-alt"
          aria-hidden="true"
        ></i>
        
        <time datetime="2024-10-11T00:00:00+00:00">October 11, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-fw fa-clock"
          aria-hidden="true"
        ></i>
        
          5
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Logging is an implementation decision that should be deferred as late as possible. Loggable lets you defer it until runtime!
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /projects/entity-manager/sql-vs-nosql/ -->
        <!-- normLogCommonTags: 0.6666666666666666 -->
        <!-- logAge: 5.0 -->
        <!-- relevance: 47000 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/collections/entity-manager/sql-vs-nosql-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/entity-manager/sql-vs-nosql/" rel="permalink">SQL vs NoSQL
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-clock"
          aria-hidden="true"
        ></i>
        
          4
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A well-tuned NoSQL database can outperform an RDBMS by orders of magnitude at scale… but not for free! Entity Manager helps close the gap.
</p>
  </article>
</div>


        
        
        
      
        
        
        
        
        
      

        
      

        
        <!-- post_url: /projects/entity-manager/evolving-a-nosql-db-schema/ -->
        <!-- normLogCommonTags: 0.6666666666666666 -->
        <!-- logAge: 5.0 -->
        <!-- relevance: 47000 -->

        
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/collections/entity-manager/evolving-a-nosql-db-schema-square.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/entity-manager/evolving-a-nosql-db-schema/" rel="permalink">Evolving a NoSQL Database Schema
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i
          class="far fa-clock"
          aria-hidden="true"
        ></i>
        
          31
          minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In a NoSQL environment, Entity Manager organizes the physical distribution of data to support efficient query operations.
</p>
  </article>
</div>


        
        
        
          
    </div>
  </div>

  
</div>
      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id" role="search">
    <label class="sr-only" for="cse-search-input-box-id">
      Enter your search term...
    </label>
    <input type="search" id="cse-search-input-box-id" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results">
    <gcse:searchresults-only></gcse:searchresults-only>
  </div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  
    <span class="love">Built for you with ❤️ on <a href="/bali/">Bali</a>!</span>
  

  <ul class="social-icons">
    
      <li>
        <strong>Contact</strong>&nbsp;&nbsp;&nbsp;</li>
    

    
      
        
          <li>
            <a href="https://twitter.com/karmaniverous" rel="nofollow noopener noreferrer">
              <i class="fa-brands fa-x-twitter" aria-hidden="true"></i>
              </a>
          </li>
        
      
        
          <li>
            <a href="https://techhub.social/@karmaniverous" rel="nofollow noopener noreferrer">
              <i class="fa-brands fa-mastodon" aria-hidden="true"></i>
              </a>
          </li>
        
      
        
          <li>
            <a href="https://github.com/karmaniverous" rel="nofollow noopener noreferrer">
              <i class="fa-brands fa-github" aria-hidden="true"></i>
              </a>
          </li>
        
      
        
          <li>
            <a href="https://www.linkedin.com/in/jscroft/" rel="nofollow noopener noreferrer">
              <i class="fa-brands fa-linkedin" aria-hidden="true"></i>
              </a>
          </li>
        
      
        
          <li>
            <a href="https://wa.me/17737500338" rel="nofollow noopener noreferrer">
              <i class="fa-brands fa-square-whatsapp" aria-hidden="true"></i>
              </a>
          </li>
        
      
        
          <li>
            <a href="https://t.me/karmaniverous" rel="nofollow noopener noreferrer">
              <i class="fa-brands fa-telegram" aria-hidden="true"></i>
              </a>
          </li>
        
      
        
          <li>
            <a href="https://calendly.com/karmaniverous" rel="nofollow noopener noreferrer">
              <i class="fa-regular fa-calendar-plus" aria-hidden="true"></i>
              </a>
          </li>
        
      
    

    
      <li>
        <a href="/feed.xml">
          <i class="fas fa-fw fa-rss-square" aria-hidden="true"></i>
           </a>
      </li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024
  <a href="https://karmanivero.us">some words</a>. Powered by
  <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a>
  &amp;
  <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>


<script>
  (function () {
    var cx = '960ee5d1b2fec4509';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
    $(document).ready(function () {
      $('input#cse-search-input-box-id').on('keyup', function () {
        googleCustomSearchExecute();
      });
    });
  
</script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "https://karmanivero.us/the-big-miss-turning-lemons-into-lemonade/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/the-big-miss-turning-lemons-into-lemonade"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://some-words.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  




  </body>
</html>
